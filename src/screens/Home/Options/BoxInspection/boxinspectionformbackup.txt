import React, { useState, useEffect, useCallback } from 'react';
import { Keyboard, View, StyleSheet, FlatList } from 'react-native';
import { SafeAreaView } from '@components/containers';
import { NavigationHeader } from '@components/Header';
import { LoadingButton } from '@components/common/Button';
import { showToast } from '@utils/common';
import { post } from '@api/services/utils';
import { RoundedScrollContainer } from '@components/containers';
import { TextInput as FormInput } from '@components/common/TextInput';
import { useAuthStore } from '@stores/auth';
import { formatDate } from '@utils/common/date';
import { validateFields } from '@utils/validation';
import { fetchInventoryDetails } from '@api/details/detailApi';
import NonInspectedBoxItems from './NonInspectedBoxItems';
import { COLORS, FONT_FAMILY } from '@constants/theme';
import { OverlayLoader } from '@components/Loader';
import { EmptyState } from '@components/common/empty';
import Text from '@components/Text';

const BoxInspectionForm = ({ navigation, route }) => {
  const { boxId, boxName } = route?.params?.item || {};
  const currentUser = useAuthStore(state => state.user);
  const [loading, setLoading] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [boxItems, setBoxItems] = useState([])

  const [formData] = useState({
    date: new Date(),
    salesPerson: { id: currentUser?.related_profile?._id || '', label: currentUser?.related_profile?.name },
    warehouse: { id: currentUser?.warehouse?.warehouse_id || '', label: currentUser?.warehouse?.warehouse_name },
  });

  const [errors, setErrors] = useState({});

  useEffect(() => {
    if (boxId) {
      setLoading(true);
      const fetchInventoryBoxItems = async () => {
        try {
          const [boxItems] = await fetchInventoryDetails(boxId)
          setBoxItems(boxItems?.items.map((item) => ({
            ...item,
            quantity: item.quantity,
            inspectedQuantity: 0
          })))

        } catch (error) {
          showToast({
            type: 'error',
            title: 'Error',
            message: 'Failed to fetch dropdown data. Please try again later.',
          });
        } finally {
          setLoading(false);
        }
      }
      fetchInventoryBoxItems()
    }
  }, [boxId, boxName])

  const renderEmptyState = () => (
    <EmptyState imageSource={require('@assets/images/EmptyData/empty_inventory_box.png')} message="Inspected items are empty" />
  );

  const handleQuantityChange = useCallback((id, text) => {
    const newQuantity = parseInt(text) || 0;
    setBoxItems((prevItems) =>
      prevItems.map((item) =>
        item._id === id
          ? { ...item, inspectedQuantity: newQuantity }
          : item
      )
    );
  }, []);

  const renderContent = () => (
    <FlatList
      data={boxItems || []}
      ListHeaderComponent={(<View><Text style={styles.label}>Inspected Items</Text></View>)}
      numColumns={1}
      renderItem={({ item }) => (
        <NonInspectedBoxItems
          item={item}
          onQuantityChange={(id, text) => handleQuantityChange(id, text)}
        />
      )}
      keyExtractor={(item, index) => index.toString()}
      showsVerticalScrollIndicator={false}
      estimatedItemSize={100}
    />
  );


  const validateForm = fieldsToValidate => {
    Keyboard.dismiss();
    const { isValid, errors } = validateFields(formData, fieldsToValidate);
    setErrors(errors);
    return isValid;
  };

  const prepareBoxInspectionData = () => ({
    date: formData.date || null,
    box_id: boxId ?? null,
    sales_person_id: formData.salesPerson?.id || null,
    inspected_items: boxItems.map(item => ({
      product_id: item.product_id,
      product_name: item.product_name,
      box_quantity: item.quantity,
      inspected_quantity: item.inspectedQuantity,
      uom_id: item.uom_id || null,
      uom_name: item.uom_name || '',
    })),
    warehouse_id: formData.warehouse?.id || null,
  });

  const prepareInventoryRequestData = () => ({
    items: boxItems.map(item => ({
      product_id: item.product_id,
      product_name: item.product_name,
      box_quantity: 0,
      uom_id: item.uom_id || null,
      uom_name: item.uom_name || '',
    })),
    quantity: 0,
    reason: 'inspection',
    box_id: boxId,
    sales_person_id: formData.salesPerson?.id || null,
    box_status: 'pending',
    request_status: 'requested',
    warehouse_name: formData.warehouse?.label || '',
    warehouse_id: formData.warehouse?.id,
  });

  const submitData = async (url, data, successMessage, errorMessage) => {
    try {
      const response = await post(url, data);
      if (response.success) {
        showToast({
          type: 'success',
          title: 'Success',
          message: response.message || successMessage,
        });
        navigation.navigate('BoxInspection');
      } else {
        showToast({
          type: 'error',
          title: 'Error',
          message: response.message || errorMessage,
        });
      }
    } catch (error) {
      showToast({
        type: 'error',
        title: 'Error',
        message: 'An unexpected error occurred. Please try again later.',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSubmit = async () => {
    const fieldsToValidate = ['salesPerson'];
    if (validateForm(fieldsToValidate)) {
      setIsSubmitting(true);

      const boxInspectionData = prepareBoxInspectionData();
      const inventoryRequestData = prepareInventoryRequestData();

      await submitData('/createInventoryBoxRequest', inventoryRequestData, 'Inventory Box Request created successfully', 'Inventory Box Request creation failed');
      await submitData('/createBoxInspection', boxInspectionData, 'Box Inspection created successfully', 'Box Inspection failed');
    }
  };


  return (
    <SafeAreaView>
      <NavigationHeader
        title="Add Box Inspection"
        onBackPress={() => navigation.goBack()}
      />
      <RoundedScrollContainer>
        <FormInput
          label="Date"
          dropIcon="calendar"
          editable={false}
          value={formatDate(formData.date)}
        />
        <FormInput
          label="Warehouse"
          editable={false}
          required
          validate={errors.salesPerson}
          value={formData.warehouse?.label || ''}
          onPress={() => { }}
        />
        <FormInput
          label="Inspected By"
          editable={false}
          required
          validate={errors.salesPerson}
          value={formData.salesPerson?.label || ''}
          onPress={() => { }}
        />
        <FormInput
          label="Box Name"
          required
          placeholder="Select Box Name"
          editable={false}
          validate={errors.box}
          value={boxName || ''}
        />
        {boxItems?.length === 0 ? renderEmptyState() : renderContent()}
        <OverlayLoader visible={loading} />
        <LoadingButton title="SUBMIT" onPress={handleSubmit} loading={isSubmitting} marginTop={10} />
      </RoundedScrollContainer>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  label: {
    marginVertical: 5,
    fontSize: 16,
    color: COLORS.primaryThemeColor,
    fontFamily: FONT_FAMILY.urbanistSemiBold,
  },
})


export default BoxInspectionForm;
